<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test TTS Tiếng Việt trên Android</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        textarea {
            width: 95%;
            min-height: 100px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            margin-right: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        #speakButton { background-color: #4CAF50; /* Xanh lá */ }
        #stopButton { background-color: #f44336; /* Đỏ */ }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #debugLogContainer {
            margin-top: 20px;
            padding: 10px;
            background-color: #333; /* Nền tối hơn cho container */
            color: #fff; /* Chữ trắng cho tiêu đề */
            border-radius: 5px;
        }
        #debugLog {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #555; /* Viền đậm hơn */
            background-color: #1e1e1e; /* Nền đen cho log */
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            color: #0f0; /* Màu chữ xanh lá cho log mặc định */
        }
        #debugLog .warn { color: #ff0; /* Vàng cho warning */ }
        #debugLog .error { color: #f00; /* Đỏ cho error */ }
        small { color: #555; }
    </style>
</head>
<body>
    <h1>Test TTS Tiếng Việt trên Android</h1>

    <textarea id="textToSpeak" placeholder="Nhập văn bản tiếng Việt vào đây...">Xin chào các bạn. Đây là thử nghiệm đọc văn bản tiếng Việt.</textarea>
    <br>
    <button id="speakButton">Đọc</button>
    <button id="stopButton">Dừng</button>
    <p><small>Lưu ý: Đảm bảo thiết bị Android của bạn đã cài đặt và chọn gói giọng nói tiếng Việt trong cài đặt Text-to-Speech của hệ thống.</small></p>

    <div id="debugLogContainer">
        <h4>Log gỡ lỗi TTS:</h4>
        <div id="debugLog"></div>
    </div>

    <script>
        let logDivElement = null;
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        function appendToLogDiv(type, args) {
            if (logDivElement) {
                const message = Array.from(args).map(arg => {
                    if (arg instanceof ErrorEvent && arg.error === undefined) { // Xử lý trường hợp event.error là undefined
                        return `ErrorEvent (error: undefined, message: ${arg.message || 'N/A'})`;
                    }
                    if (arg instanceof Event) { // Log chung cho các Event khác
                        return `Event (type: ${arg.type}, isTrusted: ${arg.isTrusted})`;
                    }
                    if (arg instanceof Error) return arg.stack || arg.message;
                    if (typeof arg === 'object' && arg !== null) return JSON.stringify(arg, null, 2);
                    return String(arg);
                }).join(' ');
                const entry = document.createElement('div');
                entry.className = type.toLowerCase();
                entry.textContent = `[${type}] ${new Date().toLocaleTimeString()}: ${message}`;
                logDivElement.appendChild(entry);
                logDivElement.scrollTop = logDivElement.scrollHeight;
            }
        }

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            appendToLogDiv('LOG', args);
        };
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            appendToLogDiv('WARN', args);
        };
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            appendToLogDiv('ERROR', args);
        };

        let voices = [];
        let currentUtterance = null;
        let ttsVoicesLoadedAtLeastOnce = false;
        let speakButton, stopButton, textToSpeakArea;

        function populateVoiceList() {
            if (typeof speechSynthesis === 'undefined') {
                console.warn('Trình duyệt không hỗ trợ speechSynthesis.');
                return;
            }
            voices = speechSynthesis.getVoices();
            if (voices.length > 0) {
                ttsVoicesLoadedAtLeastOnce = true;
            }
            console.log("populateVoiceList được gọi. Số lượng giọng đọc:", voices.length, ". Đã tải giọng ít nhất một lần:", ttsVoicesLoadedAtLeastOnce);
            voices.forEach((v, index) => {
                console.log(`Giọng ${index}: Tên=${v.name}, Ngôn ngữ=${v.lang}, Mặc định=${v.default}, Local=${v.localService}`);
            });
        }

        function speakText() {
            console.log("Hàm speakText() được gọi.");
            if (typeof speechSynthesis === 'undefined') {
                console.error("speechSynthesis không được hỗ trợ.");
                alert("Trình duyệt của bạn không hỗ trợ Text-to-Speech.");
                return;
            }

            if (!ttsVoicesLoadedAtLeastOnce && voices.length === 0) {
                console.warn("Danh sách giọng đọc chưa được tải (onvoiceschanged có thể chưa kích hoạt hoặc không tìm thấy giọng đọc).");
                alert('Danh sách giọng đọc chưa sẵn sàng. Vui lòng đợi giây lát và thử lại. Nếu lỗi tiếp diễn, hãy kiểm tra log gỡ lỗi.');
                // Thử populate lại một lần nữa nếu chưa load được
                // populateVoiceList(); // Có thể bỏ nếu đã chắc chắn onvoiceschanged hoạt động
                return;
            }

            if (speechSynthesis.speaking || speechSynthesis.pending) {
                console.log("Đang có nội dung khác được đọc hoặc chờ đọc, hủy bỏ...");
                speechSynthesis.cancel(); // Hủy bỏ việc đọc hiện tại trước khi bắt đầu cái mới
            }

            const text = textToSpeakArea.value;
            if (!text.trim()) {
                alert("Không có nội dung để đọc.");
                console.log("Không có nội dung để đọc.");
                return;
            }

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'vi-VN';

            console.log("Đang tìm giọng đọc tiếng Việt. Tổng số giọng đọc có sẵn:", voices.length);
            const vietnameseVoice = voices.find(voice => voice.lang === 'vi-VN' && voice.localService) || voices.find(voice => voice.lang === 'vi-VN');

            if (vietnameseVoice) {
                currentUtterance.voice = vietnameseVoice;
                console.log("Đã chọn giọng đọc tiếng Việt:", vietnameseVoice.name, "| Ngôn ngữ:", vietnameseVoice.lang, "| Local:", vietnameseVoice.localService);
            } else {
                console.warn("Không tìm thấy giọng đọc tiếng Việt ('vi-VN') cụ thể trong danh sách. Sẽ dựa vào cài đặt mặc định của trình duyệt.");
                if (voices.length > 0) {
                    console.warn("Có các giọng đọc khác nhưng không có 'vi-VN'. Lỗi 'synthesis-failed' rất có thể xảy ra.");
                } else {
                    console.error("Không có giọng đọc nào được trình duyệt cung cấp. Kiểm tra cài đặt TTS hệ thống và trình duyệt.");
                }
            }

            currentUtterance.onstart = () => {
                console.log("Sự kiện onstart: Bắt đầu đọc TTS.");
                speakButton.disabled = true;
                stopButton.disabled = false;
            };

            currentUtterance.onend = () => {
                console.log("Sự kiện onend: Kết thúc đọc TTS.");
                speakButton.disabled = false;
                stopButton.disabled = true;
                currentUtterance = null;
            };

            currentUtterance.onerror = (event) => {
                // Log chi tiết hơn cho event.error undefined
                let errorMessage = event.error;
                if (event.error === undefined) {
                    errorMessage = "Lỗi không xác định (event.error is undefined)";
                    console.error('Sự kiện onerror TTS:', errorMessage, 'Chi tiết sự kiện:', event);
                } else {
                    console.error('Sự kiện onerror TTS:', event.error, 'Chi tiết sự kiện:', event);
                }
                alert(`Lỗi đọc TTS: ${errorMessage}. Vui lòng kiểm tra log gỡ lỗi.`);
                speakButton.disabled = false;
                stopButton.disabled = true;
                currentUtterance = null;
            };

            speakButton.disabled = true;
            stopButton.disabled = false;
            console.log("Gọi speechSynthesis.speak() với văn bản:", `"${text.substring(0, 70)}..."`);
            speechSynthesis.speak(currentUtterance);
        }

        function stopSpeech() {
            console.log("Hàm stopSpeech() được gọi.");
            if (typeof speechSynthesis === 'undefined' || (!speechSynthesis.speaking && !speechSynthesis.pending)) {
                console.log("Không có gì đang đọc hoặc chờ đọc để dừng.");
                return;
            }
            console.log("Yêu cầu dừng đọc TTS thông qua cancel().");
            speechSynthesis.cancel();
            // Trạng thái nút sẽ được cập nhật bởi onend/onerror của utterance bị hủy
            // nhưng để chắc chắn, cập nhật luôn ở đây:
            speakButton.disabled = false;
            stopButton.disabled = true;
            currentUtterance = null;
        }

        window.addEventListener('DOMContentLoaded', () => {
            logDivElement = document.getElementById('debugLog');
            console.log("Sự kiện DOMContentLoaded. Trang đã tải xong.");

            speakButton = document.getElementById('speakButton');
            stopButton = document.getElementById('stopButton');
            textToSpeakArea = document.getElementById('textToSpeak');

            if (typeof speechSynthesis !== 'undefined') {
                console.log("Trình duyệt có hỗ trợ speechSynthesis.");
                // Gán onvoiceschanged một lần và gọi populateVoiceList để lấy danh sách ban đầu
                speechSynthesis.onvoiceschanged = () => {
                    console.log("Sự kiện onvoiceschanged của speechSynthesis được kích hoạt.");
                    populateVoiceList();
                };
                populateVoiceList(); // Lấy danh sách giọng đọc ban đầu
            } else {
                console.warn('Text-to-Speech không được hỗ trợ trên trình duyệt này.');
                alert('Text-to-Speech không được hỗ trợ trên trình duyệt này.');
                if(speakButton) speakButton.disabled = true;
                if(stopButton) stopButton.disabled = true;
            }

            if(speakButton) speakButton.onclick = speakText;
            if(stopButton) {
                stopButton.onclick = stopSpeech;
                stopButton.disabled = true; // Ban đầu nút dừng bị vô hiệu hóa
            }
        });

    </script>
</body>
</html>
