<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trích xuất nội dung truyện</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

    <style>
        /* CSS giữ nguyên như trước */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            color: #1a237e;
            font-size: 2.5em;
            text-transform: uppercase;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(45deg, #1a237e, #3949ab);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h3 {
            color: #1a237e;
            border-bottom: 2px solid #1a237e;
            padding-bottom: 5px;
            margin-top: 25px;
        }

        div {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
            font-size: 16px;
            box-sizing: border-box; /* Thêm để padding không làm tăng kích thước */
        }

        button {
            background-color: #1a237e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
            font-size: 1em;
        }

        button:hover {
            background-color: #3949ab;
        }

        button:active {
            transform: translateY(1px);
        }

        /* Các màu sắc nút cụ thể */
        button[onclick="fetchMultipleUrls()"] { background-color: #2196F3; }
        button[onclick="generateNextUrls()"] { background-color: #9C27B0; }
        button[onclick="replaceWithNextUrls()"] { background-color: #FF5722; }
        button[onclick="showUrlHistory()"] { background-color: #FF9800; } /* Màu mới cho nút Lịch sử */
        button[onclick*="clear"] { background-color: #f44336; }
        button[onclick="copyToClipboard()"] { background-color: #4CAF50; }
        button[onclick="extractFromInputAndAddToCollection()"] { background-color: #009688; }


        #progress-container {
            display: none;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            padding: 10px;
        }

        #progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        #progress-bar-fill {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
        }

        #progress-text {
            text-align: center;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            button {
                width: 100%;
                margin-bottom: 5px;
                padding: 15px 30px;
                font-size: 1.1em;
                min-width: 100px;
                min-height: 48px;
            }

            textarea {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <h1>Trích xuất nội dung truyện</h1>

    <div>
        <h3>1. Nhập URLs (mỗi URL một dòng):</h3>
        <textarea id="urls" rows="5" cols="80" placeholder="https://truyenfull.vision/ba-vo-khai-hoang/chuong-734/"></textarea>
        <div id="progress-container">
            <div id="progress-bar">
                <div id="progress-bar-fill"></div>
            </div>
            <p id="progress-text"></p>
        </div>
        <br>
        <button onclick="fetchMultipleUrls()">Lấy nội dung tất cả URLs</button>
        <button onclick="generateNextUrls()">Tạo URL tiếp theo</button>
        <button onclick="replaceWithNextUrls()">Xóa và tạo 4 URL mới</button>
        <button onclick="showUrlHistory()">Lịch sử URL</button> <button onclick="clearUrls()">Xóa URLs</button>
    </div>

    <div>
        <h3>2. Tổng hợp nội dung:</h3>
        <textarea id="collection" rows="20" cols="80" readonly></textarea>
        <br>
        <button onclick="copyToClipboard()">Copy vào Clipboard</button>
    </div>

    <div>
        <h3>3. Nội dung HTML:</h3>
        <textarea id="input" rows="10" cols="80" placeholder="Hoặc dán HTML vào đây..."></textarea>
        <br>
        <button onclick="extractFromInputAndAddToCollection()">Trích xuất & Thêm vào tổng hợp</button>
        <button onclick="clearInput()">Xóa nội dung</button>
    </div>

    <script>
    const URLS_STORAGE_KEY = 'savedStoryUrls';
    const HISTORY_STORAGE_KEY = 'urlHistory';
    const MAX_HISTORY_SIZE = 50; // Giới hạn số lượng URL trong lịch sử

    // --- Khởi tạo khi tải trang ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Tải URLs đã lưu vào textarea
        const savedUrls = localStorage.getItem(URLS_STORAGE_KEY);
        if (savedUrls) {
            document.getElementById('urls').value = savedUrls;
        }

        // 2. Gắn listener để tự động lưu khi nội dung textarea thay đổi
        const urlsTextarea = document.getElementById('urls');
        urlsTextarea.addEventListener('input', () => {
            localStorage.setItem(URLS_STORAGE_KEY, urlsTextarea.value);
        });
    });

    // --- Hàm quản lý lịch sử ---
    function getHistory() {
        const historyJson = localStorage.getItem(HISTORY_STORAGE_KEY);
        return historyJson ? JSON.parse(historyJson) : [];
    }

    function addToHistory(url) {
        let history = getHistory();
        // Loại bỏ URL nếu đã tồn tại để đưa lên đầu
        history = history.filter(item => item !== url);
        // Thêm URL mới vào đầu danh sách
        history.unshift(url);
        // Giới hạn kích thước lịch sử
        history = history.slice(0, MAX_HISTORY_SIZE);
        // Lưu lại vào localStorage
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(history));
    }

    async function showUrlHistory() {
        const history = getHistory();
        if (history.length === 0) {
            Swal.fire('Lịch sử trống', 'Chưa có URL nào được xử lý thành công.', 'info');
            return;
        }

        // Tạo options cho select input của SweetAlert2
        const inputOptions = {};
        history.forEach((url, index) => {
            // Hiển thị URL ngắn gọn hơn nếu quá dài (tùy chọn)
            // const displayUrl = url.length > 70 ? url.substring(0, 67) + '...' : url;
            inputOptions[url] = url; // Giá trị là chính URL đó
        });

        const { value: selectedUrl } = await Swal.fire({
            title: 'Lịch sử URL',
            input: 'select',
            inputOptions: inputOptions,
            inputPlaceholder: 'Chọn một URL từ lịch sử',
            showCancelButton: true,
            cancelButtonText: 'Hủy',
            confirmButtonText: 'Thêm vào ô nhập',
        });

        if (selectedUrl) {
            const urlsTextarea = document.getElementById('urls');
            // Thêm URL đã chọn vào dòng mới trong textarea
            urlsTextarea.value += (urlsTextarea.value.trim() ? '\n' : '') + selectedUrl;
            // Lưu lại thay đổi vào localStorage
            localStorage.setItem(URLS_STORAGE_KEY, urlsTextarea.value);
        }
    }

    // --- Các hàm xử lý chính (có cập nhật để dùng history) ---
    async function fetchMultipleUrls() {
        const urlsText = document.getElementById('urls').value;
        const urls = urlsText.split('\n').filter(url => url.trim());

        if (urls.length === 0) {
            Swal.fire('Cảnh báo', 'Vui lòng nhập ít nhất một URL.', 'warning');
            return;
        }

        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressText = document.getElementById('progress-text');
        const progressContainer = document.getElementById('progress-container');
        progressContainer.style.display = 'block';
        progressBarFill.style.width = '0%';
        progressText.textContent = '';

        let allContent = '';
        let successCount = 0;
        let failCount = 0;
        const currentCollection = document.getElementById('collection').value; // Lấy nội dung hiện có

        for (let i = 0; i < urls.length; i++) {
            const currentUrl = urls[i].trim(); // URL đang xử lý
            const progress = ((i + 1) / urls.length) * 100;
            progressBarFill.style.width = `${progress}%`;
            progressText.textContent = `Đang xử lý URL ${i + 1}/${urls.length}`;

            try {
                const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(currentUrl);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Lỗi mạng khi fetch URL (${response.status})`);

                const data = await response.json();
                if (data.contents) {
                    const content = await extractContent(data.contents); // Gọi hàm trích xuất
                    if (content) {
                        allContent += content + '\n\n';
                        successCount++;
                        addToHistory(currentUrl); // *** Thêm URL vào lịch sử khi thành công ***
                    } else {
                         console.warn(`Không trích xuất được nội dung từ URL ${currentUrl}`);
                         // Không thêm vào lịch sử nếu không trích xuất được
                         failCount++; // Coi như thất bại nếu không trích xuất được nội dung
                    }
                } else {
                     // Nếu proxy không trả về 'contents'
                    throw new Error('Proxy không trả về nội dung HTML');
                }
            } catch (error) {
                console.error(`Lỗi khi xử lý URL ${currentUrl}:`, error);
                failCount++;
            }
             // Thêm delay nhỏ giữa các request để tránh bị chặn (tùy chọn)
             // await new Promise(resolve => setTimeout(resolve, 200));
        }

        // Nối nội dung mới vào nội dung cũ trong collection
        document.getElementById('collection').value = currentCollection + allContent;
        progressContainer.style.display = 'none';

        Swal.fire({
            icon: failCount > 0 ? (successCount > 0 ? 'warning' : 'error') : 'success',
            title: 'Hoàn thành!',
            text: `Thành công: ${successCount} URL\nThất bại: ${failCount} URL`,
        });
    }

    function processText(text) {
        // Chuẩn hóa xuống dòng và khoảng trắng
        text = text.replace(/\r\n/g, '\n'); // Đảm bảo chỉ có \n
        text = text.replace(/[ \t]*\n[ \t]*/g, '\n'); // Xóa khoảng trắng thừa quanh \n
        text = text.replace(/\n{3,}/g, '\n\n'); // Tối đa 2 dòng trắng liên tiếp

        // Xử lý xuống dòng thông minh hơn (ví dụ: không ngắt giữa câu)
        // Đây là một ví dụ đơn giản, có thể cần tinh chỉnh
        text = text.replace(/(?<![\.\?\!"”\)\]\}])\s*\n(?![-–"“‘\(\[\{A-Z0-9])/g, ' '); // Nối dòng nếu không phải cuối câu hoặc bắt đầu đoạn mới

        // Thêm xuống dòng sau dấu chấm câu nếu chưa có
        text = text.replace(/([\.!\?…])\s*(?![\n"”’\)\]\}])/g, '$1\n');

        // Xử lý dấu gạch đầu dòng cho hội thoại
        text = text.replace(/^\s*([-–—])\s*/gm, '\n$1 ');

        // Đảm bảo khoảng cách sau dấu gạch đầu dòng
        text = text.replace(/([-–—])([^\s])/g, '$1 $2');

        // Xóa dòng trắng ở đầu và cuối
        text = text.trim();

        return text;
    }


    async function extractContent(html) {
        if (!html) return '';

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // --- Tiêu đề ---
        const truyenTitleEl = doc.querySelector('.truyen-title a, .breadcrumb li:nth-last-child(2) a'); // Thử nhiều selector cho tên truyện
        const chapterTitleEl = doc.querySelector('.chapter-title, h1.entry-title'); // Thử nhiều selector cho tên chương
        let title = '';
        const truyenTitle = truyenTitleEl ? truyenTitleEl.textContent.trim() : '';
        const chapterTitle = chapterTitleEl ? chapterTitleEl.textContent.trim() : '';

        if (truyenTitle && chapterTitle) {
             title = `${truyenTitle.toUpperCase()} - ${chapterTitle.toUpperCase()}\n\n`;
        } else if (chapterTitle) {
             title = `${chapterTitle.toUpperCase()}\n\n`; // Chỉ lấy tiêu đề chương nếu có
        }


        // --- Nội dung ---
        let chapterContentElement = doc.querySelector('#chapter-c, .entry-content, .reading-content, #content, article .text-left'); // Thử nhiều selector phổ biến
        if (!chapterContentElement) {
            console.error('Không tìm thấy phần tử nội dung chính.');
            return ''; // Trả về rỗng nếu không tìm thấy
        }

        // Loại bỏ các phần tử không mong muốn (quảng cáo, script, style,...)
        const selectorsToRemove = [
            '.ads-responsive', '.ads-chapter-bottom-lien-quan', 'script', 'style',
            'iframe', 'ins', '.hidden', '[style*="display:none"]', '[style*="display: none"]',
            '#comment', '.wpd-comment-thread', '.nav-links', '.chapter-nav', // Các phần tử phổ biến khác
            'a[href*="truyenfull"]', // Link quảng cáo/điều hướng trên một số trang
            'div[class*="google"]', 'div[id*="google"]', // Adsense
            'div[class*="ads"]', 'div[id*="ads"]', // Chung chung cho ads
            'button', 'input', 'select', 'textarea' // Các control không cần thiết
        ];
        chapterContentElement.querySelectorAll(selectorsToRemove.join(', ')).forEach(el => el.remove());


        // Xử lý <br> và <p> để tạo đoạn văn
        let content = '';
        // Duyệt qua các node con trực tiếp của khối nội dung
        chapterContentElement.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) {
                // Nếu là text node, lấy text và chuẩn hóa khoảng trắng
                const text = node.textContent.replace(/\s+/g, ' ').trim();
                 if (text) content += text + ' '; // Thêm dấu cách cuối để nối với node sau
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                 if (node.tagName === 'P') {
                     // Nếu là thẻ P, lấy text và thêm 2 dòng mới
                     const pText = node.textContent.replace(/\s+/g, ' ').trim();
                     if (pText) {
                         content = content.trimEnd() + '\n\n' + pText + '\n\n'; // Đảm bảo có dòng trắng trước và sau P
                     }
                 } else if (node.tagName === 'BR') {
                     // Nếu là BR, và không phải là cuối cùng của một đoạn đã có \n\n, thì thêm \n
                     if (!content.endsWith('\n\n') && !content.endsWith('\n')) {
                         content = content.trimEnd() + '\n';
                     }
                 } else {
                     // Với các thẻ khác (div, span,...), lấy text bên trong và thêm dấu cách
                     const innerText = node.textContent.replace(/\s+/g, ' ').trim();
                     if (innerText) content += innerText + ' ';
                 }
            }
        });

        // Áp dụng hàm processText để chuẩn hóa lần cuối
        content = processText(content.trim());

        // Trả về tiêu đề + nội dung
        return title + content;
    }

    async function extractFromInputAndAddToCollection() {
        const html = document.getElementById('input').value;
        if (!html.trim()) {
             Swal.fire('Cảnh báo', 'Vui lòng dán nội dung HTML vào ô.', 'warning');
            return;
        }
        const content = await extractContent(html); // Gọi hàm trích xuất
        if (content) {
            document.getElementById('collection').value += content + '\n\n';
             Swal.fire('Đã thêm!', 'Nội dung trích xuất đã được thêm vào ô Tổng hợp.', 'success');
        } else {
             Swal.fire('Lỗi', 'Không thể trích xuất nội dung từ HTML được cung cấp.', 'error');
        }
    }


    function generateNextUrls() {
        const urlsText = document.getElementById('urls').value.trim();
        if (!urlsText) {
             Swal.fire('Cảnh báo', 'Vui lòng nhập ít nhất một URL.', 'warning');
            return;
        }

        const lines = urlsText.split('\n').filter(line => line.trim());
        const lastUrl = lines[lines.length - 1];

        const chapterMatch = lastUrl.match(/(?:chuong|chapter)-(\d+)/i); // Tìm 'chuong-' hoặc 'chapter-' và số theo sau, không phân biệt hoa thường
        if (!chapterMatch || chapterMatch.length < 2) {
             Swal.fire('Lỗi', 'Không tìm thấy mẫu số chương (ví dụ: chuong-123 hoặc chapter-123) trong URL cuối cùng.', 'error');
            return;
        }

        const chapterNum = parseInt(chapterMatch[1]);
        const prefix = chapterMatch[0].split('-')[0]; // Lấy 'chuong' hoặc 'chapter'
        const baseUrl = lastUrl.substring(0, chapterMatch.index); // Phần URL trước 'chuong-' hoặc 'chapter-'
        const suffix = lastUrl.substring(chapterMatch.index + chapterMatch[0].length); // Phần URL sau số chương (thường là '/' hoặc trống)


        let newUrls = '';
        for (let i = 1; i <= 3; i++) { // Tạo 3 URL tiếp theo
            const nextChapter = chapterNum + i;
            newUrls += `${baseUrl}${prefix}-${nextChapter}${suffix}\n`;
        }

        const urlsTextarea = document.getElementById('urls');
        urlsTextarea.value = urlsText + '\n' + newUrls.trim();
        localStorage.setItem(URLS_STORAGE_KEY, urlsTextarea.value); // Lưu lại thay đổi
    }

    function replaceWithNextUrls() {
         const urlsText = document.getElementById('urls').value.trim();
        if (!urlsText) {
             Swal.fire('Cảnh báo', 'Vui lòng nhập ít nhất một URL.', 'warning');
            return;
        }
        const lines = urlsText.split('\n').filter(line => line.trim());
        const lastUrl = lines[lines.length - 1];

        const chapterMatch = lastUrl.match(/(?:chuong|chapter)-(\d+)/i);
         if (!chapterMatch || chapterMatch.length < 2) {
            Swal.fire('Lỗi', 'Không tìm thấy mẫu số chương (ví dụ: chuong-123 hoặc chapter-123) trong URL cuối cùng.', 'error');
            return;
        }

        const chapterNum = parseInt(chapterMatch[1]);
        const prefix = chapterMatch[0].split('-')[0];
        const baseUrl = lastUrl.substring(0, chapterMatch.index);
        const suffix = lastUrl.substring(chapterMatch.index + chapterMatch[0].length);

        let newUrls = '';
        for (let i = 1; i <= 4; i++) { // Tạo 4 URL mới
            const nextChapter = chapterNum + i;
            newUrls += `${baseUrl}${prefix}-${nextChapter}${suffix}\n`;
        }
        const urlsTextarea = document.getElementById('urls');
        urlsTextarea.value = newUrls.trim(); // Ghi đè toàn bộ nội dung cũ
        localStorage.setItem(URLS_STORAGE_KEY, urlsTextarea.value); // Lưu lại thay đổi
    }

    function clearUrls() {
        const urlsTextarea = document.getElementById('urls');
        urlsTextarea.value = '';
        localStorage.removeItem(URLS_STORAGE_KEY); // Xóa khỏi localStorage khi người dùng chủ động xóa
    }

    function clearInput() {
        document.getElementById('input').value = '';
    }

    async function copyToClipboard() {
        const text = document.getElementById('collection').value;
         if (!text.trim()) { // Kiểm tra xem có nội dung không (sau khi bỏ khoảng trắng)
             Swal.fire('Thông báo', 'Không có nội dung để sao chép.', 'info');
            return;
         }
        try {
            await navigator.clipboard.writeText(text);
            Swal.fire('Đã sao chép!', 'Nội dung đã được sao chép vào clipboard', 'success');
        } catch (err) {
            console.error('Không thể sao chép vào clipboard:', err);
             // Cung cấp hướng dẫn sao chép thủ công
             Swal.fire({
                icon: 'error',
                title: 'Lỗi sao chép tự động',
                text: 'Không thể tự động sao chép. Vui lòng chọn thủ công (Ctrl+A hoặc Cmd+A để chọn hết, sau đó Ctrl+C hoặc Cmd+C để sao chép).',
             });
        }
    }

    </script>
</body>
</html>
