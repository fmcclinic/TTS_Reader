<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trích xuất nội dung truyện</title>
</head>
<body>
    <h1>Trích xuất nội dung truyện</h1>
    
    <div>
        <h3>Dán HTML vào đây:</h3>
        <textarea id="input" rows="10" cols="80"></textarea>
        <br>
        <button onclick="extractContent()">Trích xuất nội dung</button>
    </div>
    
    <div>
        <h3>Kết quả:</h3>
        <textarea id="output" rows="20" cols="80" readonly></textarea>
        <br>
        <button onclick="saveAsText()">Lưu thành file text</button>
    </div>

    <script>
        function extractContent() {
            const html = document.getElementById('input').value;
            
            // Tạo DOM parser
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Lấy title
            let title = '';
            const truyenTitle = doc.querySelector('.truyen-title');
            const chapterTitle = doc.querySelector('.chapter-title');
            if (truyenTitle && chapterTitle) {
                title = truyenTitle.textContent.trim() + ' - ' + chapterTitle.textContent.trim() + '\n\n';
            }
            
            // Tìm phần nội dung chính
            const chapterContent = doc.querySelector('#chapter-c');
            if (!chapterContent) {
                document.getElementById('output').value = 'Không tìm thấy nội dung chính';
                return;
            }

            // Xóa các phần quảng cáo
            const ads = chapterContent.querySelectorAll('.ads-responsive, .ads-chapter-bottom-lien-quan');
            ads.forEach(ad => ad.remove());

            // Chuyển đổi thẻ br thành xuống dòng thật
            const brs = chapterContent.querySelectorAll('br');
            brs.forEach(br => {
                br.parentNode.replaceChild(doc.createTextNode('\n'), br);
            });

            // Lấy tất cả text nodes
            let content = '';
            const walk = document.createTreeWalker(
                chapterContent,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function(node) {
                        return NodeFilter.FILTER_ACCEPT;
                    }
                }
            );

            let node;
            while (node = walk.nextNode()) {
                let text = node.textContent;
                if (text.trim()) {
                    // Thêm xuống dòng nếu text bắt đầu với dấu gạch ngang
                    if (text.trim().startsWith('–') || text.trim().startsWith('-')) {
                        content += '\n' + text;
                    } else {
                        content += text;
                    }
                    
                    // Thêm xuống dòng sau mỗi thẻ p
                    if (node.parentNode.tagName === 'P') {
                        content += '\n\n';
                    }
                }
            }
            
            // Làm sạch kết quả cuối cùng
            content = content
                .replace(/\n\s+\n/g, '\n\n')   // Gộp các dòng trống có khoảng trắng
                .replace(/\n{3,}/g, '\n\n')    // Giảm xuống dòng thừa thành 2 dòng
                .trim();                       // Xóa khoảng trắng đầu/cuối
            
            // Thêm title vào đầu nội dung
            content = title + content;
            
            document.getElementById('output').value = content;
        }
        
        function saveAsText() {
            const content = document.getElementById('output').value;
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'noidung.txt';
            
            document.body.appendChild(a);
            a.click();
            
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    </script>
</body>
</html>